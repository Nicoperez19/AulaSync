@php
$horariosModulos = [
    'lunes' => [
        1 => ['inicio' => '08:10:00', 'fin' => '09:00:00'],
        2 => ['inicio' => '09:10:00', 'fin' => '10:00:00'],
        3 => ['inicio' => '10:10:00', 'fin' => '11:00:00'],
        4 => ['inicio' => '11:10:00', 'fin' => '12:00:00'],
        5 => ['inicio' => '12:10:00', 'fin' => '13:00:00'],
        6 => ['inicio' => '13:10:00', 'fin' => '14:00:00'],
        7 => ['inicio' => '14:10:00', 'fin' => '15:00:00'],
        8 => ['inicio' => '15:10:00', 'fin' => '16:00:00'],
        9 => ['inicio' => '16:10:00', 'fin' => '17:00:00'],
        10 => ['inicio' => '17:10:00', 'fin' => '18:00:00'],
        11 => ['inicio' => '18:10:00', 'fin' => '19:00:00'],
        12 => ['inicio' => '19:10:00', 'fin' => '20:00:00'],
        13 => ['inicio' => '20:10:00', 'fin' => '21:00:00'],
        14 => ['inicio' => '21:10:00', 'fin' => '22:00:00'],
        15 => ['inicio' => '22:10:00', 'fin' => '23:00:00'],
    ],
    'martes' => [
        1 => ['inicio' => '08:10:00', 'fin' => '09:00:00'],
        2 => ['inicio' => '09:10:00', 'fin' => '10:00:00'],
        3 => ['inicio' => '10:10:00', 'fin' => '11:00:00'],
        4 => ['inicio' => '11:10:00', 'fin' => '12:00:00'],
        5 => ['inicio' => '12:10:00', 'fin' => '13:00:00'],
        6 => ['inicio' => '13:10:00', 'fin' => '14:00:00'],
        7 => ['inicio' => '14:10:00', 'fin' => '15:00:00'],
        8 => ['inicio' => '15:10:00', 'fin' => '16:00:00'],
        9 => ['inicio' => '16:10:00', 'fin' => '17:00:00'],
        10 => ['inicio' => '17:10:00', 'fin' => '18:00:00'],
        11 => ['inicio' => '18:10:00', 'fin' => '19:00:00'],
        12 => ['inicio' => '19:10:00', 'fin' => '20:00:00'],
        13 => ['inicio' => '20:10:00', 'fin' => '21:00:00'],
        14 => ['inicio' => '21:10:00', 'fin' => '22:00:00'],
        15 => ['inicio' => '22:10:00', 'fin' => '23:00:00'],
    ],
    'miercoles' => [
        1 => ['inicio' => '08:10:00', 'fin' => '09:00:00'],
        2 => ['inicio' => '09:10:00', 'fin' => '10:00:00'],
        3 => ['inicio' => '10:10:00', 'fin' => '11:00:00'],
        4 => ['inicio' => '11:10:00', 'fin' => '12:00:00'],
        5 => ['inicio' => '12:10:00', 'fin' => '13:00:00'],
        6 => ['inicio' => '13:10:00', 'fin' => '14:00:00'],
        7 => ['inicio' => '14:10:00', 'fin' => '15:00:00'],
        8 => ['inicio' => '15:10:00', 'fin' => '16:00:00'],
        9 => ['inicio' => '16:10:00', 'fin' => '17:00:00'],
        10 => ['inicio' => '17:10:00', 'fin' => '18:00:00'],
        11 => ['inicio' => '18:10:00', 'fin' => '19:00:00'],
        12 => ['inicio' => '19:10:00', 'fin' => '20:00:00'],
        13 => ['inicio' => '20:10:00', 'fin' => '21:00:00'],
        14 => ['inicio' => '21:10:00', 'fin' => '22:00:00'],
        15 => ['inicio' => '22:10:00', 'fin' => '23:00:00'],
    ],
    'jueves' => [
        1 => ['inicio' => '08:10:00', 'fin' => '09:00:00'],
        2 => ['inicio' => '09:10:00', 'fin' => '10:00:00'],
        3 => ['inicio' => '10:10:00', 'fin' => '11:00:00'],
        4 => ['inicio' => '11:10:00', 'fin' => '12:00:00'],
        5 => ['inicio' => '12:10:00', 'fin' => '13:00:00'],
        6 => ['inicio' => '13:10:00', 'fin' => '14:00:00'],
        7 => ['inicio' => '14:10:00', 'fin' => '15:00:00'],
        8 => ['inicio' => '15:10:00', 'fin' => '16:00:00'],
        9 => ['inicio' => '16:10:00', 'fin' => '17:00:00'],
        10 => ['inicio' => '17:10:00', 'fin' => '18:00:00'],
        11 => ['inicio' => '18:10:00', 'fin' => '19:00:00'],
        12 => ['inicio' => '19:10:00', 'fin' => '20:00:00'],
        13 => ['inicio' => '20:10:00', 'fin' => '21:00:00'],
        14 => ['inicio' => '21:10:00', 'fin' => '22:00:00'],
        15 => ['inicio' => '22:10:00', 'fin' => '23:00:00'],
    ],
    'viernes' => [
        1 => ['inicio' => '08:10:00', 'fin' => '09:00:00'],
        2 => ['inicio' => '09:10:00', 'fin' => '10:00:00'],
        3 => ['inicio' => '10:10:00', 'fin' => '11:00:00'],
        4 => ['inicio' => '11:10:00', 'fin' => '12:00:00'],
        5 => ['inicio' => '12:10:00', 'fin' => '13:00:00'],
        6 => ['inicio' => '13:10:00', 'fin' => '14:00:00'],
        7 => ['inicio' => '14:10:00', 'fin' => '15:00:00'],
        8 => ['inicio' => '15:10:00', 'fin' => '16:00:00'],
        9 => ['inicio' => '16:10:00', 'fin' => '17:00:00'],
        10 => ['inicio' => '17:10:00', 'fin' => '18:00:00'],
        11 => ['inicio' => '18:10:00', 'fin' => '19:00:00'],
        12 => ['inicio' => '19:10:00', 'fin' => '20:00:00'],
        13 => ['inicio' => '20:10:00', 'fin' => '21:00:00'],
        14 => ['inicio' => '21:10:00', 'fin' => '22:00:00'],
        15 => ['inicio' => '22:10:00', 'fin' => '23:00:00'],
    ],
];

// Función para obtener el día actual en español
$diaActual = strtolower(
    [
            'domingo',
            'lunes',
            'martes',
            'miercoles',
            'jueves',
            'viernes',
            'sabado'
    ][date('w')]
);

// Función para determinar el módulo actual según la hora
if (!function_exists('moduloActualDashboard')) {
        function moduloActualDashboard($horariosModulos, $diaActual)
        {
        $horaAhora = date('H:i:s');
            if (!isset($horariosModulos[$diaActual]))
                return null;
        foreach ($horariosModulos[$diaActual] as $num => $horario) {
            if ($horaAhora >= $horario['inicio'] && $horaAhora < $horario['fin']) {
                return $num;
            }
        }
        return null;
    }
}
$moduloActualNum = moduloActualDashboard($horariosModulos, $diaActual);
$moduloActualHorario = $moduloActualNum ? $horariosModulos[$diaActual][$moduloActualNum] : null;
@endphp

<x-app-layout>
    <x-slot name="header">
        <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
            <h2 class="text-xl font-semibold leading-tight" style="font-style: oblique;">
                {{ __('Dashboard') }}
            </h2>
            <div class="flex items-center gap-4">
                <!-- Botón de control de auto-refresh -->
                <div class="flex items-center gap-2">
                    <button id="toggle-auto-refresh"
                        class="flex items-center gap-2 px-3 py-2 text-sm font-medium text-white transition-colors bg-blue-600 rounded-lg refresh-button hover:bg-blue-700">
                        <span id="auto-refresh-icon">🔄</span>
                        <span id="auto-refresh-text">Auto-refresh ON</span>
                    </button>
                </div>
            </div>
        </div>
    </x-slot>

    <!-- Filtros globales compactos -->
    <div class="p-8 mb-8 overflow-hidden bg-white rounded-md shadow-md dark:bg-dark-eval-1">
        <div class="flex flex-wrap items-center justify-between w-full gap-4">
            <!-- Filtros básicos -->
            <div class="flex items-center gap-2">
                <label class="font-semibold">Semana:</label>
                <select class="w-40 border-gray-300 rounded-md shadow-sm">
                    <option>Semana actual</option>
                    <option>Semana anterior</option>
                    <option>Hace 2 semanas</option>
                </select>
            </div>
            <div class="flex items-center gap-2">
                <label class="font-semibold">Piso:</label>
                <div class="relative">
                    <select id="piso-selector"
                        class="w-32 transition-all duration-300 border-gray-300 rounded-md shadow-sm"
                        onchange="cambiarPiso(this.value)">
                        <option value="">Todos</option>
                        @foreach($pisos as $pisoItem)
                            <option value="{{ $pisoItem->numero_piso }}" {{ $piso == $pisoItem->numero_piso ? 'selected' : '' }}>
                                Piso {{ $pisoItem->numero_piso }}
                            </option>
                        @endforeach
                    </select>
                    <div id="piso-loading" class="absolute hidden transform -translate-y-1/2 right-2 top-1/2">
                        <div class="w-4 h-4 border-b-2 border-blue-600 rounded-full animate-spin"></div>
                    </div>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <label class="font-semibold">Tipo de sala:</label>
                <select class="w-40 border-gray-300 rounded-md shadow-sm">
                    <option>Todas</option>
                    @foreach($comparativaTipos as $tipo)
                        <option>{{ $tipo['nombre'] }}</option>
                    @endforeach
                </select>
            </div>
        </div>
    </div>

    <!-- KPIs principales -->
    <div class="w-full p-8 mb-8">
        <div class="grid w-full grid-cols-1 gap-8 sm:grid-cols-2 md:grid-cols-4 lg:grid-cols-6">
            <!-- Total de reservas hoy -->
            <div class="flex flex-col items-center justify-center p-6 bg-white shadow-lg rounded-xl widget-transition">
                <span class="mb-2 text-4xl text-blue-500">📅</span>
                <div class="mb-1 text-base font-bold text-blue-700">Total de reservas hoy</div>
                <div id="total-reservas-hoy" class="text-2xl font-bold text-blue-700 kpi-value">{{ $totalReservasHoy }}
                </div>
            </div>
            <!-- % No Presentación -->
            <div class="flex flex-col items-center justify-center p-6 bg-white shadow-lg rounded-xl widget-transition">
                <span class="mb-2 text-4xl text-yellow-500">📉</span>
                <div class="mb-1 text-base font-bold text-yellow-700">% No Presentación</div>
                <div id="kpi-no-show" class="text-2xl font-bold text-yellow-700 kpi-value">{{ $porcentajeNoShow }}%
                </div>
            </div>
            <!-- Usuarios sin escaneo -->
            <div class="flex flex-col items-center justify-center p-6 bg-white shadow-lg rounded-xl widget-transition">
                <span class="mb-2 text-5xl text-red-500">❌</span>
                <div class="mb-1 text-base font-bold text-red-700">Usuarios sin escaneo</div>
                <div id="usuarios-sin-escaneo" class="text-xs text-center text-red-600 kpi-value">
                    {{ $usuariosSinEscaneo }} usuarios sin registrar asistencia hoy
                </div>
            </div>
            <!-- Horas utilizadas / disponibles -->
            <div class="flex flex-col items-center justify-center p-6 bg-white shadow-lg rounded-xl widget-transition">
                <img src="https://img.icons8.com/color/48/000000/hourglass--v2.png" class="w-12 h-12 mb-2" />
                <div class="text-xs text-gray-500">Horas utilizadas / disponibles</div>
                <div id="horas-utilizadas" class="mt-1 text-2xl font-bold text-yellow-700 kpi-value">
                    {{ $horasUtilizadas['utilizadas'] }} / {{ $horasUtilizadas['disponibles'] }}
                </div>
            </div>
            <!-- Ocupación semanal -->
            <div
                class="relative flex flex-col items-center justify-center p-6 bg-white shadow-lg rounded-xl widget-transition">
                <img src="https://img.icons8.com/color/48/000000/combo-chart--v2.png" class="w-12 h-12 mb-2" />
                <div class="text-xs text-gray-500">% Ocupación semanal</div>
                <div id="ocupacion-semanal"
                    class="flex items-center gap-2 mt-1 text-3xl font-bold text-primary-600 kpi-value">
                    {{ $ocupacionSemanal }}%
                    <span class="text-xl text-green-500" title="Subió respecto a la semana anterior">▲</span>
                </div>
            </div>
            <!-- Ocupación mensual -->
            <div
                class="relative flex flex-col items-center justify-center p-6 bg-white shadow-lg rounded-xl widget-transition">
                <img src="https://img.icons8.com/color/48/000000/line-chart.png" class="w-12 h-12 mb-2" />
                <div class="text-xs text-gray-500">Promedio ocupación mensual</div>
                <div id="ocupacion-mensual"
                    class="flex items-center gap-2 mt-1 text-3xl font-bold text-primary-600 kpi-value">
                    {{ $ocupacionMensual }}%
                    <span class="text-xl text-green-500" title="Subió respecto al mes anterior">▲</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Gráfico de barras: Reservas por tipo de espacio -->
    <div
        class="w-full p-8 mb-8 bg-white rounded-xl shadow-lg flex flex-col items-center min-h-[260px] relative widget-transition">
        <h4 class="flex items-center gap-2 mb-4 font-semibold text-gray-700">Reservas por tipo de espacio <span
                class="ml-2 cursor-pointer"
                title="Cantidad de reservas por tipo de espacio (aula, laboratorio, etc.)">ℹ️</span></h4>
        <canvas id="grafico-reservas-tipo-espacio" width="500" height="300"></canvas>
    </div>

    <!-- Grid de gráficos secundarios -->
    <div class="grid w-full grid-cols-1 gap-8 p-8 mb-8 md:grid-cols-2">
        <!-- Gráfico de barras: Uso por Día -->
        <div
            class="p-8 bg-white rounded-xl shadow-lg flex flex-col items-center min-h-[260px] relative widget-transition w-full">
            <h4 class="flex items-center gap-2 mb-4 font-semibold text-gray-700">Gráfico de Barras: Uso por Día <span
                    class="ml-2 cursor-pointer"
                    title="Muestra la cantidad de horas ocupadas por día de la semana">ℹ️</span></h4>
            <canvas id="grafico-barras" width="500" height="300"></canvas>
        </div>
        <!-- Gráfico de barras horizontal: Top 3 salas más usadas -->
        <div
            class="p-8 bg-white rounded-xl shadow-lg flex flex-col items-center min-h-[260px] relative widget-transition w-full">
            <h4 class="flex items-center gap-2 mb-4 font-semibold text-gray-700">Top 3 Salas más usadas <span
                    class="ml-2 cursor-pointer" title="Ranking de salas según uso mensual">ℹ️</span></h4>
            <canvas id="grafico-top-salas" width="500" height="300"></canvas>
        </div>
        <!-- Gráfico de barras: Top asignaturas por uso -->
        <div
            class="p-8 bg-white rounded-xl shadow-lg flex flex-col items-center min-h-[260px] relative widget-transition w-full">
            <h4 class="flex items-center gap-2 mb-4 font-semibold text-gray-700">Top asignaturas por uso <span
                    class="ml-2 cursor-pointer" title="Asignaturas con mayor uso de espacios">ℹ️</span></h4>
            <canvas id="grafico-top-asignaturas" width="500" height="300"></canvas>
        </div>
        <!-- Gráfico de áreas: Comparativa tipos de espacios -->
        <div
            class="p-8 bg-white rounded-xl shadow-lg flex flex-col items-center min-h-[260px] relative widget-transition w-full">
            <h4 class="flex items-center gap-2 mb-4 font-semibold text-gray-700">Comparativa de ocupación por tipo de
                espacio <span class="ml-2 cursor-pointer"
                    title="Comparación de ocupación entre aulas, laboratorios, etc.">ℹ️</span></h4>
            <canvas id="grafico-comparativa-tipos" width="500" height="300"></canvas>
        </div>
        <!-- Gráfico de línea: Promedio mensual -->
        <div
            class="p-8 bg-white rounded-xl shadow-lg flex flex-col items-center min-h-[260px] relative widget-transition w-full">
            <h4 class="flex items-center gap-2 mb-4 font-semibold text-gray-700">Evolución semanal de ocupación <span
                    class="ml-2 cursor-pointer"
                    title="Tendencia del promedio de ocupación de la semana actual">ℹ️</span></h4>
            <canvas id="grafico-mensual" width="500" height="300"></canvas>
        </div>
        <!-- Gráfico de ocupación diaria -->
        <div
            class="p-8 bg-white rounded-xl shadow-lg flex flex-col items-center min-h-[260px] relative widget-transition w-full">
            <h4 class="flex items-center gap-2 mb-4 font-semibold text-gray-700">Ocupación diaria por módulo <span
                    class="ml-2 cursor-pointer" title="Ocupación por módulo del día actual">ℹ️</span></h4>
            <div class="flex flex-wrap justify-center gap-2">
                @foreach($ocupacionDiaria as $dia => $porcentaje)
                    <div class="text-center">
                        <div
                            class="text-sm font-bold {{ $porcentaje > 70 ? 'text-green-700' : ($porcentaje > 50 ? 'text-yellow-500' : 'text-red-500') }}">
                            {{ $porcentaje }}%
                        </div>
                        <div class="text-xs text-gray-500">{{ $dia }}</div>
                    </div>
                @endforeach
            </div>
        </div>
    </div>

    <div class="flex flex-col w-full gap-8 p-4 mb-8 md:p-8 md:flex-row">
        <div class="flex flex-col flex-1 gap-6">
            <div class="p-4 bg-white rounded-lg shadow-md md:p-6 dark:bg-gray-800">
                <!-- Encabezado con título y botón alineados -->
                <div class="flex items-center justify-between mb-4">
                    <h1 class="text-2xl font-bold text-gray-800 dark:text-gray-100">
                        Utilización de Espacios por Tipo
                    </h1>
                    <x-button class="inline-flex items-center gap-2 px-4 py-2 mt-3 text-sm font-medium hover:bg-red-700"
                        variant="primary" href="{{ route('reporteria.utilizacion_por_espacio') }}">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-6">
                            <path
                                d="M18.375 2.25c-1.035 0-1.875.84-1.875 1.875v15.75c0 1.035.84 1.875 1.875 1.875h.75c1.035 0 1.875-.84 1.875-1.875V4.125c0-1.036-.84-1.875-1.875-1.875h-.75ZM9.75 8.625c0-1.036.84-1.875 1.875-1.875h.75c1.036 0 1.875.84 1.875 1.875v11.25c0 1.035-.84 1.875-1.875 1.875h-.75a1.875 1.875 0 0 1-1.875-1.875V8.625ZM3 13.125c0-1.036.84-1.875 1.875-1.875h.75c1.036 0 1.875.84 1.875 1.875v6.75c0 1.035-.84 1.875-1.875 1.875h-.75A1.875 1.875 0 0 1 3 19.875v-6.75Z" />
                        </svg>
                        Ver detalles
                    </x-button>
                </div>
                <div class="flex flex-wrap items-center justify-between gap-4 text-sm text-gray-500 dark:text-gray-300">
                    <div class="flex flex-wrap items-center gap-4">
                        <span class="inline-flex items-center gap-2 px-3 py-1 text-gray-500 dark:text-gray-300">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-gray-600" fill="none"
                                viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            @if($moduloActualNum)
                                Módulo {{ $moduloActualNum }} ({{ substr($moduloActualHorario['inicio'], 0, 5) }} -
                                {{ substr($moduloActualHorario['fin'], 0, 5) }})
                            @else
                                No hay módulo disponible
                            @endif
                        </span>
                        <span class="inline-flex items-center gap-2 px-3 py-1 text-gray-500 dark:text-gray-300">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-gray-600 dark:text-gray-300"
                                fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                            {{ ucfirst($diaActual) }}, {{ \Carbon\Carbon::now()->format('d/m/Y') }}
                        </span>
            </div>
                </div>
            </div>
            <div class="p-4 bg-white rounded-lg shadow-md md:p-6 dark:bg-gray-800">
            <div id="tabla-utilizacion-tipo-espacio" class="overflow-x-auto">
                @include('partials.tabla_utilizacion_tipo_espacio', ['comparativaTipos' => $comparativaTipos])
            </div>
        </div>
        </div>
        <div
            class="flex flex-col items-center justify-center w-full md:w-[260px] lg:w-[340px] bg-white rounded-xl shadow-lg p-6 md:p-8 widget-transition flex-shrink-0 md:mt-0 mt-8">
            <h4 class="mb-4 text-lg font-bold text-center text-gray-700">Salas ocupadas / libres (hoy)</h4>
            <canvas 
                id="grafico-circular-salas" 
                class="mb-2 w-full max-w-[220px] h-auto aspect-square" 
                style="max-width:220px;"
            ></canvas>
            <div class="flex justify-center gap-4 mt-2">
                <div class="flex items-center gap-1">
                    <span class="inline-block w-4 h-4 rounded-full" style="background-color: #10b981;"></span>
                    <span class="text-sm text-gray-700">Libres</span>
                </div>
                <div class="flex items-center gap-1">
                    <span class="inline-block w-4 h-4 rounded-full" style="background-color: #ef4444;"></span>
                    <span class="text-sm text-gray-700">Ocupadas</span>
                </div>
            </div>
            <div id="salas-ocupadas" class="mt-4 text-2xl font-bold kpi-value" style="color:#a21caf;">
                {{ $salasOcupadas['ocupadas'] }} <span class="text-gray-400"> de </span> {{ $salasOcupadas['libres'] }}
            </div>
        </div>
    </div>

    <!-- Tablas -->
    <div class="w-full p-8 mb-8">
        <div class="p-8 mb-8 bg-white shadow-lg rounded-xl">
            <!-- Reservas canceladas o no utilizadas -->
            <div class="flex items-center justify-between mb-4">
                <h3 class="flex items-center gap-2 text-lg font-bold text-gray-700">Reservas canceladas o no utilizadas
                    <span class="ml-2 cursor-pointer"
                        title="Reservas que no fueron utilizadas o se cancelaron">ℹ️</span>
                </h3>
                <div>
                    <label for="filtro_fecha_no_utilizadas" class="mr-2 font-semibold">Fecha:</label>
                    <input type="date" id="filtro_fecha_no_utilizadas" name="filtro_fecha_no_utilizadas"
                        value="{{ request('filtro_fecha_no_utilizadas', \Carbon\Carbon::now()->format('Y-m-d')) }}"
                        class="px-2 py-1 border rounded" />
                </div>
            </div>
            <div id="tabla-no-utilizadas-dia" class="overflow-x-auto">
                <!-- Aquí se cargará la tabla por AJAX -->
                @include('partials.tabla_no_utilizadas_dia', ['noUtilizadasDia' => $noUtilizadasDia ?? []])
            </div>
        </div>
        <div class="p-8 mb-8 bg-white shadow-lg rounded-xl">
            <!-- Reservas activas sin devolución -->
            <div class="flex items-center justify-between mb-4">
                <h3 class="flex items-center gap-2 text-lg font-bold text-gray-700">Reservas Activas Sin Devolución
                    <span class="ml-2 cursor-pointer"
                        title="Usuarios que han registrado el ingreso a una sala pero no han registrado la salida.">ℹ️</span>
                </h3>
            </div>
            <div class="overflow-x-auto">
                <table id="tabla-reservas-activas"
                    class="min-w-full text-center border border-gray-300 rounded-lg dark:bg-dark-eval-1">
                    <thead>
                        <tr class="bg-gray-200 dark:bg-dark-eval-2">
                            <th class="px-4 py-2 border">Usuario</th>
                            <th class="px-4 py-2 border">Espacio Reservado</th>
                            <th class="px-4 py-2 border">Fecha de Reserva</th>
                            <th class="px-4 py-2 border">Hora de Ingreso</th>
                        </tr>
                    </thead>
                    <tbody>
                        @forelse($reservasSinDevolucion as $reserva)
                        <tr class="bg-white dark:bg-dark-eval-1">
                            <td class="border">{{ $reserva->user->name }}</td>
                                <td class="border">{{ $reserva->espacio->nombre_espacio }}
                                    ({{ $reserva->espacio->id_espacio }})</td>
                                <td class="border">{{ \Carbon\Carbon::parse($reserva->fecha_reserva)->format('d/m/Y') }}
                                </td>
                            <td class="border">{{ $reserva->hora }}</td>
                        </tr>
                        @empty
                        <tr class="bg-white dark:bg-dark-eval-1">
                            <td colspan="4" class="p-4 text-center text-gray-500">
                                No hay reservas activas sin devolución en este momento.
                            </td>
                        </tr>
                        @endforelse
                    </tbody>
                </table>
            </div>
        </div>
        <div class="p-8 mb-8 bg-white shadow-lg rounded-xl">
            <!-- Registro de accesos actuales -->
            <div class="flex items-center justify-between mb-4">
                <h3 class="flex items-center gap-2 text-lg font-bold text-gray-700">Registro de accesos actuales</h3>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white rounded-lg dark:bg-gray-800">
                    <thead class="bg-gray-50 dark:bg-gray-700">
                        <tr>
                            <th
                                class="px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase dark:text-gray-300">
                                Usuario</th>
                            <th
                                class="px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase dark:text-gray-300">
                                Espacio</th>
                            <th
                                class="px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase dark:text-gray-300">
                                Fecha</th>
                            <th
                                class="px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase dark:text-gray-300">
                                Hora entrada</th>
                            <th
                                class="px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase dark:text-gray-300">
                                Hora salida</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200 dark:bg-gray-800 dark:divide-gray-700">
                        @forelse($accesosActuales as $acceso)
                            <tr class="transition-colors hover:bg-gray-50 dark:hover:bg-gray-700">
                            <td class="px-4 py-3 whitespace-nowrap">
                                <div>
                                        <div
                                            class="text-sm font-medium text-gray-900 dark:text-white @if(is_null($acceso->hora_salida)) font-bold text-green-700 @endif">
                                        {{ $acceso->user->name }}
                                    </div>
                                    <div class="text-sm text-gray-500 dark:text-gray-400">
                                        {{ $acceso->user->run }}
                                    </div>
                                    <div class="text-xs text-gray-400 dark:text-gray-500">
                                        {{ $acceso->user->email }}
                                    </div>
                                </div>
                            </td>
                            <td class="px-4 py-3 whitespace-nowrap">
                                <div>
                                    <div class="text-sm font-medium text-gray-900 dark:text-white">
                                            {{ $acceso->espacio->nombre_espacio }} - {{ $acceso->espacio->id_espacio }} -
                                            Piso {{ $acceso->espacio->piso->numero_piso ?? '-' }}
                                    </div>
                                    <div class="text-xs text-gray-400 dark:text-gray-500">
                                        {{ $acceso->espacio->piso->facultad->nombre_facultad ?? '' }}
                                    </div>
                                </div>
                            </td>
                                <td class="px-4 py-3 text-sm text-gray-900 whitespace-nowrap dark:text-white">
                                {{ \Carbon\Carbon::parse($acceso->fecha_reserva)->format('d/m/Y') }}
                            </td>
                                <td class="px-4 py-3 text-sm text-gray-900 whitespace-nowrap dark:text-white">
                                {{ $acceso->hora }}
                            </td>
                                <td class="px-4 py-3 text-sm text-gray-900 whitespace-nowrap dark:text-white">
                                {{ $acceso->hora_salida ?? '-' }}
                            </td>
                        </tr>
                        @empty
                        <tr>
                            <td colspan="5" class="px-4 py-8 text-center text-gray-500 dark:text-gray-400">
                                No hay accesos actuales.
                            </td>
                        </tr>
                        @endforelse
                    </tbody>
                </table>
            </div>
        </div>
        <div class="p-8 mb-8 bg-white shadow-lg rounded-xl">
            <!-- Horarios de la semana -->
            <h3 class="mb-4 text-lg font-bold text-gray-700">Horarios de la semana - Usuarios asignados por espacio</h3>
            @include('layouts.partials.horarios-semana', ['horariosAgrupados' => $horariosAgrupados])
        </div>
    </div>
</x-app-layout>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // ========================================
    // CONFIGURACIÓN Y VARIABLES GLOBALES
    // ========================================
    let autoRefreshInterval;
    let autoRefreshEnabled = true;
    let notificationQueue = [];
    let isShowingNotification = false;

    // ========================================
    // SISTEMA DE NOTIFICACIONES MEJORADO
    // ========================================
    function mostrarNotificacion(mensaje, tipo, duracion = 3000) {
        notificationQueue.push({ mensaje, tipo, duracion });
        if (!isShowingNotification) {
            procesarColaNotificaciones();
        }
    }

    function procesarColaNotificaciones() {
        if (notificationQueue.length === 0) {
            isShowingNotification = false;
            return;
        }

        isShowingNotification = true;
        const { mensaje, tipo, duracion } = notificationQueue.shift();

        // Remover notificaciones existentes
        const notificacionesExistentes = document.querySelectorAll('.dashboard-notification');
        notificacionesExistentes.forEach(notif => notif.remove());

        // Crear nueva notificación
        const notificacion = document.createElement('div');
        notificacion.className = `dashboard-notification fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 transition-all duration-300 ${tipo === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
        }`;
        notificacion.textContent = mensaje;
        
        document.body.appendChild(notificacion);
        
        // Remover después del tiempo especificado
        setTimeout(() => {
            if (notificacion.parentNode) {
                notificacion.remove();
            }
            // Procesar siguiente notificación
            setTimeout(procesarColaNotificaciones, 300);
        }, duracion);
    }

    // ========================================
    // FUNCIONES DE ACTUALIZACIÓN DE WIDGETS
    // ========================================
    
    // Función principal de actualización de widgets
    function actualizarWidgets(data) {
        const errores = [];
        
        // Actualizar KPIs con manejo individual de errores
        try {
            actualizarKPIs(data);
        } catch (error) {
            errores.push(`Error al actualizar KPIs: ${error.message}`);
        }

        // Actualizar ocupación diaria
        try {
            actualizarOcupacionDiaria(data.ocupacionDiaria);
        } catch (error) {
            errores.push(`Error al actualizar ocupación diaria: ${error.message}`);
        }

        // Actualizar gráficos con manejo individual
        try {
            actualizarGraficoBarras(data.usoPorDia);
        } catch (error) {
            errores.push(`Error al actualizar gráfico de uso por día: ${error.message}`);
        }

        try {
            actualizarGraficoTopSalas(data.topSalas);
        } catch (error) {
            errores.push(`Error al actualizar gráfico de top salas: ${error.message}`);
        }

        try {
            actualizarGraficoTopAsignaturas(data.topAsignaturas);
        } catch (error) {
            errores.push(`Error al actualizar gráfico de top asignaturas: ${error.message}`);
        }

        try {
            actualizarGraficoComparativaTipos(data.comparativaTipos);
        } catch (error) {
            errores.push(`Error al actualizar gráfico de comparativa de tipos: ${error.message}`);
        }

        try {
            actualizarGraficoEvolucionMensual(data.evolucionMensual);
        } catch (error) {
            errores.push(`Error al actualizar gráfico de evolución mensual: ${error.message}`);
        }

        try {
            actualizarGraficoCircularSalas(data.salasOcupadas);
        } catch (error) {
            errores.push(`Error al actualizar gráfico circular de salas: ${error.message}`);
        }

        try {
            actualizarGraficoReservasTipoEspacio(data.reservasPorTipo);
        } catch (error) {
            errores.push(`Error al actualizar gráfico de reservas por tipo: ${error.message}`);
        }

        // Actualizar tablas con manejo individual
        try {
            actualizarTablaReservasCanceladas(data.reservasCanceladas);
        } catch (error) {
            errores.push(`Error al actualizar tabla de reservas canceladas: ${error.message}`);
        }

        try {
            actualizarTablaReservasActivas(data.reservasSinDevolucion);
        } catch (error) {
            errores.push(`Error al actualizar tabla de reservas activas: ${error.message}`);
        }

        // Ocultar indicadores de carga
        ocultarCargando();

        // Mostrar errores si los hay
        if (errores.length > 0) {
            if (errores.length === 1) {
                mostrarNotificacion(errores[0], 'error', 4000);
            } else {
                mostrarNotificacion(`${errores.length} errores en la actualización. Revisa la consola para más detalles.`, 'error', 5000);
                console.error('Errores detallados:', errores);
            }
        } else {
            console.log('Dashboard actualizado exitosamente:', new Date().toLocaleTimeString());
        }
    }

    // Función para actualizar todos los KPIs
    function actualizarKPIs(data) {
        const kpis = [
            { id: 'ocupacion-semanal', valor: data.ocupacionSemanal + '%' },
            { id: 'ocupacion-mensual', valor: data.ocupacionMensual + '%' },
            { id: 'usuarios-sin-escaneo', valor: data.usuariosSinEscaneo + ' usuarios sin registrar asistencia hoy' },
            { id: 'horas-utilizadas', valor: data.horasUtilizadas.utilizadas + ' / ' + data.horasUtilizadas.disponibles },
            { id: 'salas-ocupadas', valor: data.salasOcupadas.ocupadas + ' / ' + data.salasOcupadas.libres }
        ];

        kpis.forEach(kpi => {
            actualizarKPI(kpi.id, kpi.valor);
        });
    }

    // ========================================
    // FUNCIONES DE ACTUALIZACIÓN INDIVIDUALES
    // ========================================

    function actualizarKPI(id, valor) {
        const elemento = document.getElementById(id);
        if (elemento) {
            elemento.classList.add('updating');
            elemento.textContent = valor;
            setTimeout(() => {
                elemento.classList.remove('updating');
            }, 300);
        }
    }

    function actualizarOcupacionDiaria(ocupacionDiaria) {
        const contenedor = document.querySelector('[data-widget="ocupacion-diaria"]');
        if (contenedor && ocupacionDiaria) {
            let html = '';
            for (const [dia, porcentaje] of Object.entries(ocupacionDiaria)) {
                const color = porcentaje > 70 ? 'text-green-700' : (porcentaje > 50 ? 'text-yellow-500' : 'text-red-500');
                html += `<span class="font-bold ${color}">${dia} ${porcentaje}%</span>`;
            }
            contenedor.innerHTML = html;
        }
    }

    function actualizarGraficoBarras(usoPorDia) {
        if (window.graficoBarras && usoPorDia) {
            const dias = ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];
            const datos = dias.map(dia => usoPorDia[dia] || 0);
            
            window.graficoBarras.data.datasets[0].data = datos;
            window.graficoBarras.update('active');
        }
    }

    function actualizarGraficoTopSalas(topSalas) {
        if (window.graficoTopSalas && topSalas) {
            window.graficoTopSalas.data.labels = topSalas.map(sala => sala.nombre);
            window.graficoTopSalas.data.datasets[0].data = topSalas.map(sala => sala.uso);
            window.graficoTopSalas.update('active');
        }
    }

    function actualizarGraficoTopAsignaturas(topAsignaturas) {
        if (window.graficoTopAsignaturas && topAsignaturas) {
            window.graficoTopAsignaturas.data.labels = topAsignaturas.map(asignatura => asignatura.nombre);
            window.graficoTopAsignaturas.data.datasets[0].data = topAsignaturas.map(asignatura => asignatura.uso);
            window.graficoTopAsignaturas.update('active');
        }
    }

    function actualizarGraficoComparativaTipos(comparativaTipos) {
        if (window.graficoComparativaTipos && comparativaTipos) {
            window.graficoComparativaTipos.data.labels = comparativaTipos.map(tipo => tipo.nombre);
            window.graficoComparativaTipos.data.datasets[0].data = comparativaTipos.map(tipo => tipo.total);
            window.graficoComparativaTipos.update('active');
        }
    }

    function actualizarGraficoReservasTipoEspacio(reservasPorTipo) {
        if (window.graficoReservasTipoEspacio && reservasPorTipo) {
            window.graficoReservasTipoEspacio.data.labels = reservasPorTipo.map(tipo => tipo.nombre);
            window.graficoReservasTipoEspacio.data.datasets[0].data = reservasPorTipo.map(tipo => tipo.total);
            window.graficoReservasTipoEspacio.update('active');
        }
    }

    function actualizarGraficoEvolucionMensual(evolucionMensual) {
        if (window.graficoMensual && evolucionMensual) {
            window.graficoMensual.data.labels = evolucionMensual.dias;
            window.graficoMensual.data.datasets[0].data = evolucionMensual.ocupacion;
            window.graficoMensual.update('active');
        }
    }

    function actualizarGraficoCircularSalas(salasOcupadas) {
        if (window.graficoCircularSalas && salasOcupadas) {
            window.graficoCircularSalas.data.datasets[0].data = [salasOcupadas.ocupadas, salasOcupadas.libres];
            window.graficoCircularSalas.update('active');
        }
    }

    function actualizarTablaReservasCanceladas(reservasCanceladas) {
        const tbody = document.querySelector('#tabla-reservas-canceladas tbody');
        if (tbody) {
            let html = '';
            if (reservasCanceladas && reservasCanceladas.length > 0) {
                reservasCanceladas.forEach(reserva => {
                    html += `
                        <tr class="bg-white dark:bg-dark-eval-1">
                            <td class="border">${reserva.usuario}</td>
                            <td class="border">${reserva.espacio}</td>
                            <td class="border">${reserva.hora}</td>
                            <td class="border">${reserva.hora_planificada ?? '-'}</td>
                            <td class="border">No utilizado</td>
                        </tr>
                    `;
                });
            } else {
                html = '<tr><td colspan="4" class="text-center text-gray-500 border">No hay reservas canceladas</td></tr>';
            }
            tbody.innerHTML = html;
        }
    }

    function actualizarTablaReservasActivas(reservas) {
        const tbody = document.querySelector('#tabla-reservas-activas tbody');
        if (tbody) {
            let html = '';
            if (reservas && reservas.length > 0) {
                reservas.forEach(reserva => {
                    const fecha = new Date(reserva.fecha_reserva);
                    const formattedDate = new Date(fecha.valueOf() + fecha.getTimezoneOffset() * 60000).toLocaleDateString('es-CL');
                    html += `
                        <tr class="bg-white dark:bg-dark-eval-1">
                            <td class="border">${reserva.user.name}</td>
                            <td class="border">${reserva.espacio.nombre_espacio} (${reserva.espacio.id_espacio})</td>
                            <td class="border">${formattedDate}</td>
                            <td class="border">${reserva.hora}</td>
                        </tr>
                    `;
                });
            } else {
                html = `
                    <tr class="bg-white dark:bg-dark-eval-1">
                        <td colspan="4" class="p-4 text-center text-gray-500">
                            No hay reservas activas sin devolución en este momento.
                        </td>
                    </tr>
                `;
            }
            tbody.innerHTML = html;
        }
    }

    // ========================================
    // SISTEMA DE AUTO-REFRESH MEJORADO
    // ========================================
    
    function iniciarAutoRefresh() {
        if (!autoRefreshEnabled) return;
        
        if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
        }
        
        autoRefreshInterval = setInterval(function () {
            actualizarDashboard();
        }, 30000);
        
        console.log('Auto-refresh iniciado cada 30 segundos');
        actualizarEstadoBotonAutoRefresh();
    }
    
    function detenerAutoRefresh() {
        if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
            autoRefreshInterval = null;
            console.log('Auto-refresh detenido');
        }
        actualizarEstadoBotonAutoRefresh();
    }
    
    function toggleAutoRefresh() {
        autoRefreshEnabled = !autoRefreshEnabled;
        
        if (autoRefreshEnabled) {
            iniciarAutoRefresh();
        } else {
            detenerAutoRefresh();
        }
        
        actualizarEstadoBotonAutoRefresh();
    }
    
    function actualizarEstadoBotonAutoRefresh() {
        const boton = document.getElementById('toggle-auto-refresh');
        const icono = document.getElementById('auto-refresh-icon');
        const texto = document.getElementById('auto-refresh-text');
        
        if (autoRefreshEnabled && autoRefreshInterval) {
            boton.className = 'refresh-button flex items-center gap-2 px-3 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition-colors';
            icono.textContent = '🔄';
            texto.textContent = 'Auto-refresh ON';
        } else {
            boton.className = 'refresh-button flex items-center gap-2 px-3 py-2 text-sm font-medium text-white bg-gray-500 rounded-lg hover:bg-gray-600 transition-colors';
            icono.textContent = '⏸️';
            texto.textContent = 'Auto-refresh OFF';
        }
    }
    
    function actualizarDashboard() {
        mostrarIndicadorActualizacion();
        
        return fetch('/dashboard/widget-data')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error al obtener datos del dashboard');
                }
                return response.json();
            })
            .then(data => {
                actualizarWidgets(data);
                return data;
            })
            .catch(error => {
                console.error('Error en auto-refresh:', error);
                mostrarNotificacion('Error al actualizar el dashboard: ' + error.message, 'error');
            });
    }
    
    function mostrarIndicadorActualizacion() {
        let indicador = document.getElementById('auto-refresh-indicator');
        if (!indicador) {
            indicador = document.createElement('div');
            indicador.id = 'auto-refresh-indicator';
            indicador.className = 'fixed bottom-4 right-4 bg-blue-500 text-white px-3 py-1 rounded-full text-xs opacity-75 z-50';
            indicador.innerHTML = '🔄 Actualizando...';
            document.body.appendChild(indicador);
        }
        if (indicador) indicador.style.display = 'block';
        setTimeout(() => {
            if (indicador) indicador.style.display = 'none';
        }, 2000);
    }

    // ========================================
    // FUNCIONES DE CARGA Y UTILIDADES
    // ========================================

    function mostrarCargando() {
        const widgets = document.querySelectorAll('.bg-white.rounded-xl.shadow-lg');
        widgets.forEach(widget => {
            widget.classList.add('opacity-50');
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'absolute inset-0 flex items-center justify-center bg-white bg-opacity-75 z-10';
            loadingDiv.innerHTML = '<div class="w-8 h-8 border-b-2 border-blue-600 rounded-full animate-spin"></div>';
            widget.style.position = 'relative';
            widget.appendChild(loadingDiv);
        });
    }

    function ocultarCargando() {
        const widgets = document.querySelectorAll('.bg-white.rounded-xl.shadow-lg');
        widgets.forEach(widget => {
            widget.classList.remove('opacity-50');
            const loadingDiv = widget.querySelector('.absolute.inset-0');
            if (loadingDiv) {
                loadingDiv.remove();
            }
        });
    }

    // ========================================
    // FUNCIÓN DE CAMBIO DE PISO MEJORADA
    // ========================================

    function cambiarPiso(piso) {
        const selector = document.getElementById('piso-selector');
        const loadingIndicator = document.getElementById('piso-loading');
        
        selector.disabled = true;
        loadingIndicator.classList.remove('hidden');
        mostrarCargando();
        
        fetch('/dashboard/set-piso', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
            },
            body: JSON.stringify({ piso: piso })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Error en la respuesta del servidor');
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                return fetch('/dashboard/widget-data');
            } else {
                throw new Error('Error al cambiar piso: ' + (data.message || 'Error desconocido'));
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Error al obtener datos de widgets');
            }
            return response.json();
        })
        .then(widgetData => {
            actualizarWidgets(widgetData);
            selector.disabled = false;
            loadingIndicator.classList.add('hidden');
            mostrarNotificacion('Piso cambiado exitosamente', 'success');
        })
        .catch(error => {
            console.error('Error en la petición:', error);
            selector.disabled = false;
            loadingIndicator.classList.add('hidden');
            ocultarCargando();
            mostrarNotificacion('Error al cambiar piso: ' + error.message, 'error');
        });
    }

    // ========================================
    // INICIALIZACIÓN DE GRÁFICOS
    // ========================================

    // Gráfico de barras: Uso por Día
    window.graficoBarras = new Chart(document.getElementById('grafico-barras'), {
        type: 'bar',
        data: {
            labels: ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'],
            datasets: [{
                label: 'Horas ocupadas',
                data: {!! json_encode(array_values($usoPorDia)) !!},
                backgroundColor: 'rgba(59, 130, 246, 0.7)'
            }]
        },
        options: {
            responsive: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Cantidad de reservas'
                    }
                }
            }
        }
    });

    // Gráfico de barras: Top Salas
    window.graficoTopSalas = new Chart(document.getElementById('grafico-top-salas'), {
        type: 'bar',
        data: {
            labels: {!! json_encode($topSalas->pluck('nombre')) !!},
            datasets: [{
                label: 'Uso',
                data: {!! json_encode($topSalas->pluck('uso')) !!},
                backgroundColor: 'rgba(16, 185, 129, 0.7)'
            }]
        },
        options: {
            responsive: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                x: {
                    ticks: {
                        minRotation: 90,
                        maxRotation: 90
                    }
                },
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Cantidad de reservas'
                    }
                }
            }
        }
    });

    // Gráfico de barras: Top Asignaturas
    window.graficoTopAsignaturas = new Chart(document.getElementById('grafico-top-asignaturas'), {
        type: 'bar',
        data: {
            labels: {!! json_encode($topAsignaturas->pluck('nombre')) !!},
            datasets: [{
                label: 'Uso',
                data: {!! json_encode($topAsignaturas->pluck('uso')) !!},
                backgroundColor: 'rgba(251, 191, 36, 0.7)'
            }]
        },
        options: {
            responsive: false, 
            plugins: {
                legend: { display: false }
            },
            scales: {
                x: {
                    ticks: {
                        minRotation: 45,
                        maxRotation: 45
                    }
                },
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Cantidad de planificaciones'
                    }
                }
            }
        }
    });

    // Gráfico de áreas: Comparativa tipos
    window.graficoComparativaTipos = new Chart(document.getElementById('grafico-comparativa-tipos'), {
        type: 'doughnut',
        data: {
            labels: {!! json_encode($comparativaTipos->pluck('nombre')) !!},
            datasets: [{
                data: {!! json_encode($comparativaTipos->pluck('total')) !!},
                backgroundColor: [
                    'rgba(59, 130, 246, 0.7)',
                    'rgba(16, 185, 129, 0.7)',
                    'rgba(251, 191, 36, 0.7)',
                    'rgba(239, 68, 68, 0.7)',
                    'rgba(168, 85, 247, 0.7)',
                    'rgba(236, 72, 153, 0.7)'
                ]
            }]
        },
        options: {
            responsive: false, 
            plugins: {
                legend: { position: 'bottom' },
                tooltip: {
                    callbacks: {
                        label: function (context) {
                            return context.label + ': ' + context.parsed + '%';
                        }
                    }
                }
            }
        }
    });

    // Gráfico de línea: Evolución mensual
    window.graficoMensual = new Chart(document.getElementById('grafico-mensual'), {
        type: 'line',
        data: {
            labels: {!! json_encode($evolucionMensual['dias']) !!},
            datasets: [{
                label: 'Ocupación (%)',
                data: {!! json_encode($evolucionMensual['ocupacion']) !!},
                borderColor: 'rgba(59,130,246,1)',
                backgroundColor: 'rgba(59,130,246,0.2)',
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: false, 
            plugins: {
                legend: { position: 'bottom' }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    title: {
                        display: true,
                        text: 'Porcentaje de ocupación'
                    }
                }
            }
        }
    });

    // Gráfico circular: Salas ocupadas/libres
    window.graficoCircularSalas = new Chart(document.getElementById('grafico-circular-salas'), {
        type: 'doughnut',
        data: {
            labels: ['Ocupadas', 'Libres'],
            datasets: [{
                data: [{{ $salasOcupadas['ocupadas'] }}, {{ $salasOcupadas['libres'] }}],
                backgroundColor: [
                    'rgba(239, 68, 68, 0.7)', // rojo
                    'rgba(16, 185, 129, 0.7)' // verde
                ],
                borderWidth: 2
            }]
        },
        options: {
            cutout: '70%',
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function (context) {
                            return context.label + ': ' + context.parsed;
                        }
                    }
                }
            }
        }
    });

    // Gráfico de barras: Reservas por tipo de espacio
    window.graficoReservasTipoEspacio = new Chart(document.getElementById('grafico-reservas-tipo-espacio'), {
        type: 'bar',
        data: {
            labels: {!! json_encode($reservasPorTipo->pluck('nombre')) !!},
            datasets: [{
                label: 'Reservas',
                data: {!! json_encode($reservasPorTipo->pluck('total')) !!},
                backgroundColor: 'rgba(59, 130, 246, 0.7)'
            }]
        },
        options: {
            responsive: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Cantidad de reservas'
                    }
                }
            }
        }
    });

    // ========================================
    // INICIALIZACIÓN Y EVENT LISTENERS
    // ========================================

    document.addEventListener('DOMContentLoaded', function () {
        // Configurar event listeners
        document.getElementById('toggle-auto-refresh').addEventListener('click', toggleAutoRefresh);
        
        // Iniciar auto-refresh
        iniciarAutoRefresh();
        
        // Detener auto-refresh cuando la página no esté visible
        document.addEventListener('visibilitychange', function () {
            if (document.hidden) {
                detenerAutoRefresh();
            } else if (autoRefreshEnabled) {
                iniciarAutoRefresh();
            }
        });

        // Event listener para filtro de fecha
        const input = document.getElementById('filtro_fecha_no_utilizadas');
        if (input) {
            input.addEventListener('change', function () {
                const fecha = input.value;
                fetch(`/dashboard/no-utilizadas-dia?fecha=${fecha}`)
                    .then(response => response.text())
                    .then(html => {
                        document.getElementById('tabla-no-utilizadas-dia').innerHTML = html;
                    })
                    .catch(error => {
                        console.error('Error al cargar tabla de no utilizadas:', error);
                        mostrarNotificacion('Error al cargar los datos de la tabla', 'error');
                    });
            });
        }
    });
</script>

<!-- Estilos adicionales -->
<style>
    [x-cloak] {
        display: none !important;
    }
    
    /* Transiciones suaves para los widgets */
    .widget-transition {
        transition: all 0.3s ease-in-out;
    }
    
    .widget-loading {
        opacity: 0.6;
        pointer-events: none;
    }
    
    .widget-updating {
        animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
        0%,
        100% {
            opacity: 1;
        }

        50% {
            opacity: 0.7;
        }
    }
    
    /* Animación para los KPIs */
    .kpi-value {
        transition: all 0.3s ease;
    }
    
    .kpi-value.updating {
        transform: scale(1.05);
        color: #3b82f6;
    }
    
    /* Estilos para el indicador de auto-refresh */
    #auto-refresh-indicator {
        animation: slideInUp 0.3s ease-out;
    }
    
    @keyframes slideInUp {
        from {
            transform: translateY(100%);
            opacity: 0;
        }

        to {
            transform: translateY(0);
            opacity: 0.75;
        }
    }
    
    /* Estilos para los botones de control */
    .refresh-button {
        transition: all 0.2s ease-in-out;
    }
    
    .refresh-button:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }
    
    .refresh-button:active {
        transform: translateY(0);
    }
    
    /* Animación para el icono de actualización */
    .animate-spin {
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        from {
            transform: rotate(0deg);
        }

        to {
            transform: rotate(360deg);
        }
    }
</style>